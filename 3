package services

import (
	"context"
	"encoding/base64"
	"errors"
	"fmt"
	"net/smtp"
	"time"

	"github.com/CollabTED/CollabTed-Backend/config"
	"github.com/CollabTED/CollabTed-Backend/pkg/redis"
	"github.com/CollabTED/CollabTed-Backend/pkg/types"
	"github.com/CollabTED/CollabTed-Backend/pkg/utils"
	"github.com/CollabTED/CollabTed-Backend/prisma"
	"github.com/CollabTED/CollabTed-Backend/prisma/db"
	"github.com/satori/go.uuid"
)

type AuthService struct{}

func NewAuthService() *AuthService {
	return &AuthService{}
}

func (s *AuthService) CreateUser(name string, email string, password string, profilePicture string) (*db.UserModel, error) {
	ctx := context.Background()

	encrypted_password, err := utils.Encrypt(password)
	if err != nil {
		return nil, err
	}

	// Create User
	result, err := prisma.Client.User.CreateOne(
		db.User.Email.Set(email),
		db.User.Name.Set(name),
		db.User.Password.Set(encrypted_password),
		db.User.ProfilePicture.Set(profilePicture),
		db.User.Active.Set(false),
	).Exec(ctx)

	if err != nil {
		return nil, err
	}

	// Create Personal Workspace
	_, err = NewWorkspaceService().CreateWorkspace(types.WorkspaceD{
		Name:    "Personal",
		OwnerID: result.ID,
	})

	if err != nil {
		return nil, err
	}
	return result, nil
}

func (s *AuthService) CheckUser(email string, password string) (*db.UserModel, error) {
	ctx := context.Background()
	client := db.NewClient()
	if err := client.Prisma.Connect(); err != nil {
		panic(err)
	}

	user, err := prisma.Client.User.FindUnique(
		db.User.Email.Equals(email),
	).Exec(ctx)
	if err != nil {
		return nil, errors.New("email not found")
	}

	if !user.Active {
		return nil, errors.New("user not activated")
	}

	enc_pass := user.Password
	err = utils.CheckPassword(enc_pass, password)
	if err != nil {
		return nil, errors.New("wrong password")
	}

	return user, nil
}

func (s *AuthService) GetUserByEmail(email string) (*db.UserModel, error) {
	ctx := context.Background()
	client := db.NewClient()
	if err := client.Prisma.Connect(); err != nil {
		return nil, err
	}

	user, err := client.User.FindUnique(
		db.User.Email.Equals(email),
	).Exec(ctx)
	if err != nil {
		if errors.Is(err, db.ErrNotFound) {
			return nil, nil // User not found
		}
		return nil, err // Other errors
	}

	return user, nil // User found
}

func (s *AuthService) ActivateUser(userID string) error {
	ctx := context.Background()

	_, err := prisma.Client.User.FindUnique(
		db.User.ID.Equals(userID),
	).Update(
		db.User.Active.Set(true),
	).Exec(ctx)
	if err != nil {
		return err
	}
	return nil
}


func (s *AuthService) SendRessetLink(user types.Claims) error {
	token := uuid.NewV4().Bytes()
	encoded := base64.StdEncoding.EncodeToString(token)

	r := redis.GetClient()
	r.Set(context.Background(),"resset:"+user.ID,encoded,time.Hour * 1)
	
	link := fmt.Sprint("https://collabted.com/auth/password-reset?token=%s",token)
	msg := fmt.Sprintf("Your password resset link is",link)

	smtpHost := config.EMAIL_HOST
	smtpPort := config.EMAIL_PORT
	
	auth := smtp.PlainAuth("", config.EMAIL, config.EMAIL_PASSWORD, smtpHost)
	err := smtp.SendMail(smtpHost+":"+smtpPort, auth, config.EMAIL, user.Email, []byte(msg))

}





